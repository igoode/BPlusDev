<apex:page standardController="Follow_Up__c" 
        extensions="BPFollowupExtension,BPHomeController" 
        sidebar="false" 
        showHeader="false" 
        action="{!redir}"
        cache="false">
    <apex:variable value="{!Follow_Up__c}" var="fu" />
    <div id="wrapper">
        <apex:composition template="BPTemplate" />
        <style>
            .datePicker
            {
                z-index: 102 !important;
            }
        </style>
        <script>
            $j(document).ready(function()
            {
                $j('#placedPnl').hide();
                $j('.placedBtn').click(function()
                {
                    $j('#placedPnl').dialog(
                    {
                        height: 200,
                        width: 500,
                        modal: true,
                        position: {my: "center"},
                        buttons: 
                            {
                                Close: function() 
                                {
                                    $j(this).dialog("close");
                                }
                            }
                    });
                });

                $j('.rsltChnge').change(function(e) 
                {
                    $j(e.target).addClass('changed-input');
                });
            });

            var eventTarget;
            function checkDirty(el)
            {
                eventTarget = el;
                if($j('.changed-input').length)
                {

                   $j("#dialog-confirm").dialog({
                        resizable: false,
                        height:140,
                        width:400,
                        modal: true,
                        buttons: {
                                "Continue": function() {                                                
                                    $j( this ).dialog( "close" );
                                    $j('.changed-input').removeClass('changed-input');
                                    eventTarget.click();
                                },
                                "Go Back": function() {
                                    $j( this ).dialog( "close" );
                                }
                        }
                    });
                    return false;
                }
                return true;
            }
        </script>
        <div id="content" class="end-inner end-followup">
            <apex:form >
                <c:BPNavBar JobSeeker="{!JobSeeker}" />
                <div class="end-banner">
                    <apex:image value="{!URLFOR($Resource.EndiceResources, 'banner.jpg')}"/>
                </div>
                <div id="content">
                    <div class="end-contact"> 
                        <apex:sectionHeader title="Followup" />
                        <apex:outputPanel id="details">
                            <apex:pageMessages id="msgs" />
                            <apex:pageBlock >  
                                <div class="end-contact-block end-contact-employer">
                                    <apex:pageBlockSection columns="2">
                                        <apex:outputField value="{!fu.Job_Seeker__c}" />
                                        <apex:outputField value="{!fu.Type__c}" label="Followup Type"/>
                                        <apex:outputField value="{!fu.Employer_Contact__r.Business__c}" label="Employer"/>
                                        <apex:pageBlockSectionItem />
                                        <apex:inputField value="{!fu.Due_Date__c}" />
                                        <apex:inputField value="{!fu.Due_Time__c}" />
                                        <apex:inputField value="{!fu.Assigned_To__c}" rendered="{!IsManager}" />
                                        <apex:outputField value="{!fu.Assigned_To__r.Name}" label="Asssigned To" rendered="{!NOT(IsManager)}" />
                                        <apex:outputField value="{!fu.Employer_Contact__r.Result__c}" label="Regarding" />
                                        <apex:outputField value="{!fu.Employer_Contact_Person__c}"/>
                                        <apex:outputField value="{!fu.Contact_Number__c}"/>
                                        <apex:outputField value="{!fu.Employer_Contact_Position__c}"/>
                                        <apex:outputField value="{!fu.Actioned__c}" />
                                    </apex:pageBlockSection>
                                    <apex:pageBlockSection columns="2" 
                                            rendered="{!fu.Employer_Contact__r.Result__c == Interview || fu.Employer_Contact__r.Result__c == ResumeDropOff}" >
                                        <apex:outputField value="{!fu.Interview_Date__c}"
                                                label="{!IF(fu.Employer_Contact__r.Result__c == Interview, Interview, 'Meeting')} Date"/>
                                        <apex:outputField value="{!fu.Interview_Time__c}"
                                                label="{!IF(fu.Employer_Contact__r.Result__c == Interview, Interview, 'Meeting')} Time"/>
                                    </apex:pageBlockSection>
                                    <apex:pageBlockSection columns="2" rendered="{!ISBLANK(fu.Actioned__c)}">
                                        <apex:inputField value="{!fu.Action_Taken__c}" styleClass="rsltChnge">
                                            <apex:actionSupport reRender="nextEcPnl,newJsk,msgs" event="onchange" status="spinner"/>
                                        </apex:inputField>
                                        <apex:outputPanel>
                                            <apex:commandButton value="Save"  
                                                    action="{!saveOverride}" 
                                                    status="spinner"
                                                    reRender="details,msgs,msgs2" />
                                            <input type="button"
                                                    class="btn placedBtn"
                                                    value="Jobseeker Placed" />
                                        </apex:outputPanel>
                                        <apex:inputField value="{!fu.No_Further_Action_Required__c}" styleClass="rsltChnge"/>
                                    </apex:pageBlockSection>
                                    <apex:pageBlockSection columns="2" rendered="{!NOT(ISBLANK(fu.Actioned__c))}">
                                        <apex:outputField value="{!fu.Action_Taken__c}" />
                                        <apex:outputField value="{!fu.No_Further_Action_Required__c}"/>
                                    </apex:pageBlockSection>
                                    <apex:pageBlockSection columns="2" rendered="{!NOT(ISBLANK(fu.Actioned__c))}">
                                        <apex:selectList value="{!FurtherAction}" size="1" label="Further Action">
                                            <apex:selectOption itemValue="" itemLabel="--None--" />
                                            <apex:selectOption itemValue="Call Employer" itemLabel="Call Employer" />
                                            <apex:selectOption itemValue="Call Jobseeker" itemLabel="Call Jobseeker" />
                                        </apex:selectList>
                                        <apex:outputPanel>
                                            <apex:commandButton value="Save"  
                                                    action="{!saveOverride}" 
                                                    status="spinner"
                                                    reRender="details,msgs,msgs2" />
                                            <input type="button"
                                                    class="btn placedBtn"
                                                    value="Jobseeker Placed" />
                                        </apex:outputPanel>
                                        <apex:inputField value="{!NextContact.Call_Back_Date__c}" 
                                                     styleClass="rsltChnge" />
                                        <apex:inputField value="{!NextContact.Call_Back_Time__c}"  
                                                     styleClass="rsltChnge"/>
                                    </apex:pageBlockSection>
                                    <apex:pageBlockSection columns="1" >
                                        <apex:outputField value="{!fu.Employer_Contact__r.Comment__c}" label="Original Comment" style="width:100%" />
                                    </apex:pageBlockSection>
                                    <apex:pageBlockSection columns="1">
                                        <apex:inputField value="{!fu.Comment__c}" styleClass="comment rsltChnge"/>
                                    </apex:pageBlockSection>
                                    <apex:outputPanel id="nextEcPnl">
                                        <apex:pageBlockSection columns="2" 
                                                rendered="{!ISBLANK(fu.Followup_Employer_Contact__c) &&
                                                                NOT(fu.No_Further_Action_Required__c) &&
                                                                (fu.Action_Taken__c == ResumeDropOff ||
                                                                fu.Action_Taken__c == Interview ||
                                                                fu.Action_Taken__c == 'Resume sent' ||
                                                                fu.Action_Taken__c == 'Left message' ||
                                                                fu.Action_Taken__c == 'No answer' ||
                                                                fu.Action_Taken__c == 'Call back' ||
                                                                fu.Action_Taken__c == 'Work trial organised')}">
                                            <apex:pageBlockSectionItem labelStyleClass="detailList">
                                                <label>Edit details if required</label>
                                            </apex:pageBlockSectionItem>
                                            <apex:pageBlockSectionItem />
                                            <apex:inputField value="{!NextContact.Contact_Person__c}"  styleClass="rsltChnge" />
                                            <apex:inputField value="{!NextContact.Contact_Number__c}" styleClass="rsltChnge" />
                                            <apex:inputField value="{!NextContact.Contact_Position__c}" styleClass="rsltChnge" />
                                            <apex:inputField value="{!NextContact.Contact_Email__c}" styleClass="rsltChnge" />
                                            <apex:inputField value="{!NextContact.Employer_Suburb__c}" styleClass="rsltChnge" />
                                            <apex:pageBlockSectionItem />
                                            <apex:inputField value="{!NextContact.Interview_Date__c}" 
                                                    label="{!IF(fu.Action_Taken__c == Interview, Interview, 'Meeting')} Date"
                                                    rendered="{!fu.Action_Taken__c == Interview || fu.Action_Taken__c == ResumeDropOff}" 
                                                    styleClass="rsltChnge"/>
                                            <apex:inputField value="{!NextContact.Interview_Time__c}" 
                                                    rendered="{!fu.Action_Taken__c == Interview || fu.Action_Taken__c == ResumeDropOff}"
                                                     styleClass="rsltChnge" />  
                                            <apex:inputField value="{!NextContact.Call_Back_Date__c}" 
                                                    rendered="{!fu.Action_Taken__c == 'Call back' || fu.Action_Taken__c == 'Work trial organised'}"
                                                     styleClass="rsltChnge" />
                                            <apex:inputField value="{!NextContact.Call_Back_Time__c}" 
                                                    rendered="{!fu.Action_Taken__c == 'Call back' || fu.Action_Taken__c == 'Work trial organised'}" 
                                                     styleClass="rsltChnge"/>   
                                        </apex:pageBlockSection>                    
                                    </apex:outputPanel>
                                    <apex:outputPanel id="newJsk">
                                    
                                    </apex:outputPanel>
                                    <apex:pageBlockButtons location="bottom">
                                        <apex:outputPanel layout="block" 
                                                styleClass="mapData"
                                                rendered="{!(fu.Action_Taken__c == Interview || fu.Action_Taken__c == ResumeDropOff)}" >
                                            <span>Mobile Number</span>
                                            <apex:inputText value="{!MobileNumber}" />
                                            <apex:commandButton action="{!sendEmployerDetails}" 
                                                    reRender="msgs,msgs2"
                                                    styleClass="srchRsltBtn"
                                                    value="SMS Details to Jobseeker"
                                                    status="spinner" />
                                        </apex:outputPanel>
                                        <apex:commandButton value="Save"  
                                                action="{!saveOverride}" 
                                                status="spinner"
                                                reRender="details,msgs,msgs2" />
                                        <apex:commandButton value="Back to Jobseeker"  
                                                immediate="true"
                                                action="{!URLFOR($Action.Job_Seeker__c.View, JobSeeker.ID)}" 
                                                styleClass="btn" 
                                                onclick="if(!checkDirty(this)){return false;}"/>
                                        <apex:commandButton value="Create Vacancy" 
                                                action="{!URLFOR($Page.BPVacancy, null, [empId=fu.Employer_Contact__r.Business__c])}" 
                                                styleClass="btn"
                                                onclick="if(!checkDirty(this)){return false;}"/>                                 
                                    </apex:pageBlockButtons>
                                </div>
                            </apex:pageBlock>
                            <apex:pageMessages id="msgs2" />
                        </apex:outputPanel>
                    </div>
                </div>
            </apex:form>
        </div>
         <div id="placedPnl" style="height:50px">
            <c:BPPlaced PageController="{!ThisController}" 
                    EmployerID="{!fu.Employer_Contact__r.Business__c}" 
                    FollowupID="{!fu.ID}"/>
        </div>
        <div id="dialog-confirm" title="You have unsaved changes!">
            <p>
                <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
            </p>
        </div>
        <apex:composition template="BPFooter" />
    </div>
</apex:page>